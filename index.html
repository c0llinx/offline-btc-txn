<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin HTLC Contracts</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #0d6efd;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background: #5a6268;
        }

        .nav-links a.active {
            background: #0d6efd;
        }

        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            margin-bottom: 30px;
        }

        .htlc-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .htlc-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .htlc-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #0d6efd;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn {
            background: #0d6efd;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            min-width: auto;
            width: auto;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #198754;
        }

        .btn-success:hover {
            background: #157347;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #bb2d3b;
        }

        .result-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #0d6efd;
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-family: monospace;
            word-break: break-all;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .qr-display {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .qr-display canvas {
            margin: 10px auto;
            display: block;
        }

        .success {
            background: #d1e7dd;
            color: #0f5132;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #badbcc;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            color: #0d6efd;
            font-weight: bold;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .network-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .network-status.healthy {
            background: #d1e7dd;
            color: #0f5132;
        }

        .network-status.unhealthy {
            background: #f8d7da;
            color: #721c24;
        }

        .htlc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.pending {
            background: #ffc107;
        }

        .status-indicator.active {
            background: #198754;
        }

        .status-indicator.completed {
            background: #6c757d;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #0d6efd;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 9999;
        }

        #toast.show {
            opacity: 0.95;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .htlc-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .htlc-section {
                padding: 15px;
            }
            
            .htlc-tabs {
                flex-wrap: wrap;
                justify-content: space-around;
            }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
                min-width: 120px;
            }
            
            .step-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
            
            .nav-links a {
                display: block;
                margin: 5px 0;
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .input-with-button input {
                margin-bottom: 10px;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                padding: 15px;
                font-size: 16px;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 16px;
                margin-bottom: 10px;
                white-space: nowrap;
            }
            
            .btn-secondary {
                padding: 8px 12px;
                font-size: 12px !important;
            }
            
            .result-section {
                padding: 15px;
            }
            
            .result-item {
                padding: 10px;
            }
            
            .result-value {
                padding: 8px;
                font-size: 12px;
                word-break: break-all;
            }
            
            .qr-display {
                padding: 15px;
            }
            
            .qr-display canvas {
                max-width: 150px;
                height: auto;
            }
            
            .network-status {
                font-size: 14px;
                padding: 8px;
            }
            
            #toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Bitcoin HTLC Contracts</h1>
            <p class="subtitle">Hash Time Locked Contracts for secure offline Bitcoin transactions</p>
        </div>

        <div class="nav-links">
            <a href="wallet.html">Wallet</a>
            <a href="index.html" class="active">HTLC Contracts</a>
        </div>

        <div id="network-status" class="network-status">Checking network status...</div>

        <!-- Wallet Overview Section
        <div class="htlc-section" id="wallet-overview">
            <h2>📱 Available Wallets</h2>
            <div id="wallet-list" class="htlc-grid">
                <div id="no-wallets-message" style="grid-column: 1 / -1; text-align: center; color: #6c757d;">
                    <p>No wallets found. <a href="wallet.html" style="color: #0d6efd;">Create wallets first →</a></p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" id="refresh-wallets-btn">🔄 Refresh Wallets</button>
            </div>
        </div>

        <div class="warning-box">
            <strong>⚠️ REAL BITCOIN TESTNET MODE</strong><br>
            This application creates actual Bitcoin testnet transactions that will be broadcast to the Bitcoin network. 
            Testnet Bitcoin has no monetary value but requires real network interaction.
        </div> -->

        <div class="htlc-tabs">
            <button class="tab-btn active" data-tab="sender">
                <span class="step-number">1</span>
                Create HTLC
            </button>
            <button class="tab-btn" data-tab="receiver">
                <span class="step-number">2</span>
                Claim Funds
            </button>
            <button class="tab-btn" data-tab="refund">
                <span class="step-number">3</span>
                Refund (Timeout)
            </button>
        </div>

        <!-- Sender Tab -->
        <div id="sender-tab" class="tab-content active">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="sender-status"></span>
                    Create Hash Time Locked Contract
                </h2>
                <form id="sender-form">
                    <div class="htlc-grid">
                        <div>
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Sender Wallet:</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-sender-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="sender-wallet-dropdown">
                                    <select id="sender-wallet-select" name="sender-wallet">
                                        <option value="">Select sender wallet...</option>
                                    </select>
                                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                                        <a href="wallet.html" style="color: #0d6efd;">Create wallets in Wallet page →</a>
                                    </small>
                                </div>
                                
                                <div id="sender-manual-input" class="hidden">
                                    <input type="text" id="sender-wif-manual" placeholder="Paste sender private key (WIF)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter WIF format private key (starts with 'c' for testnet)</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Receiver:</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-receiver-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="receiver-wallet-dropdown">
                                    <select id="receiver-wallet-select" name="receiver-wallet">
                                        <option value="">Select receiver wallet...</option>
                                    </select>
                                    <small style="color: #6c757d;">Receiver's public key will be used for HTLC script</small>
                                </div>
                                
                                <div id="receiver-manual-input" class="hidden">
                                    <input type="text" id="receiver-address-manual" placeholder="Paste receiver address (tb1...)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter testnet address (starts with 'tb1')</small>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label>Amount (Satoshis):</label>
                                <input type="number" name="amount" value="50000" min="1000" placeholder="50000" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Refund Timelock (Block Height):</label>
                                <input type="number" name="refund-locktime" id="refund-locktime-input" placeholder="4657600" required>
                                <small style="color: #6c757d;">Current block: <span id="current-block">Loading...</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- <button type="button" class="btn btn-secondary" id="test-form-btn" style="margin-bottom: 10px;">🧪 Test Form</button>
                    <button type="button" class="btn btn-secondary" id="fill-test-data-btn" style="margin-bottom: 10px;">📝 Fill Test Data</button>
                    <button type="button" class="btn btn-secondary" id="debug-wallets-btn" style="margin-bottom: 10px;">🔍 Debug Wallets</button>
                    <button type="button" class="btn btn-secondary" id="refresh-balances-btn" style="margin-bottom: 10px;">💰 Refresh Balances</button> -->
                    <button type="submit" class="btn btn-success">Create HTLC Funding Transaction</button>
                </form>
                
                <div id="sender-results" class="result-section hidden">
                    <h3>🎯 HTLC Created Successfully</h3>
                    <div class="htlc-grid">
                        <div>
                            <div class="result-item">
                                <div class="result-label">HTLC Contract Address</div>
                                <div class="result-value" id="htlc-address"></div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Secret Preimage</div>
                                <div class="result-value" id="preimage-display"></div>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <div class="result-label">Funding Transaction</div>
                                <div class="result-value">
                                    <a href="#" target="_blank" class="tx-link" id="funding-tx-link"></a>
                                </div>
                            </div>
                            <div class="qr-display">
                                <h4>QR Code - HTLC Data</h4>
                                <canvas id="qrcode-canvas"></canvas>
                                <button class="btn btn-secondary" id="copy-htlc-data" style="margin-top: 10px; font-size: 12px; padding: 8px 12px;">📋 Copy HTLC Data</button>
                                <p><small>Scan QR or copy data to share HTLC details with receiver</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receiver Tab -->
        <div id="receiver-tab" class="tab-content">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="receiver-status"></span>
                    Claim HTLC Funds
                </h2>
                
                <div class="htlc-grid">
                    <div>
                        <h3>Load HTLC Data</h3>
                        <button class="btn btn-secondary" id="scan-qr-btn" style="margin-bottom: 10px;">📱 Scan QR Code</button>
                        <button class="btn btn-secondary" id="paste-data-btn">📋 Paste HTLC Data</button>
                        
                        <!-- Camera scanner UI -->
                        <div id="qr-scanner" class="hidden" style="margin: 20px 0;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h4>QR Code Scanner</h4>
                                <p style="color: #6c757d; font-size: 14px;">Position QR code within the camera view</p>
                            </div>
                            <video id="qr-video" style="width: 100%; max-width: 400px; height: auto; border: 2px solid #0d6efd; border-radius: 8px; margin: 0 auto; display: block;"></video>
                            <canvas id="qr-canvas" class="hidden"></canvas>
                            <div style="text-align: center; margin-top: 15px;">
                                <button id="start-scan-btn" class="btn btn-success" style="margin: 5px;">▶️ Start Scanning</button>
                                <button id="stop-scan-btn" class="btn btn-danger" style="margin: 5px; display: none;">⏹️ Stop Scanning</button>
                                <button id="test-qr-btn" class="btn btn-secondary" style="margin: 5px; font-size: 12px;">🔧 Test QR Scanner</button>
                            </div>
                            <div id="scan-result" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px; display: none;"></div>
                        </div>
                        
                        <div id="htlc-data-display" class="result-section hidden">
                            <h4>HTLC Contract Details</h4>
                            <div id="htlc-info"></div>
                        </div>
                    </div>
                    
                    <div>
                        <form id="receiver-form" class="hidden">
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Receiver Wallet (for claiming):</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-receiver-claim-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="receiver-claim-dropdown">
                                    <select id="receiver-claim-wallet-select" name="receiver-claim-wallet" required>
                                        <option value="">Select wallet to receive funds...</option>
                                    </select>
                                    <small style="color: #6c757d;">Must match the receiver from HTLC creation</small>
                                </div>
                                
                                <div id="receiver-claim-manual-input" class="hidden">
                                    <input type="text" id="receiver-wif-manual" placeholder="Paste receiver private key (WIF)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter WIF format private key for claiming</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Claim Destination Address:</label>
                                <input type="text" id="claim-address" placeholder="tb1q..." readonly>
                                <small style="color: #6c757d;">Funds will be sent to this address</small>
                            </div>
                            
                            <button type="submit" class="btn btn-success">Claim HTLC Funds</button>
                        </form>
                    </div>
                </div>
                
                <div id="receiver-results" class="result-section hidden">
                    <h3>✅ Funds Claimed Successfully</h3>
                    <div class="result-item">
                        <div class="result-label">Claim Transaction</div>
                        <div class="result-value">
                            <a href="#" target="_blank" class="tx-link" id="claim-tx-link"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refund Tab -->
        <div id="refund-tab" class="tab-content">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="refund-status"></span>
                    Refund HTLC (After Timeout)
                </h2>
                
                <div class="htlc-grid">
                    <div>
                        <h3>HTLC Timeout Status</h3>
                        <div id="timeout-status" class="result-section">
                            <div class="result-item">
                                <div class="result-label">Current Block Height</div>
                                <div class="result-value" id="current-height">Loading...</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Timeout Block Height</div>
                                <div class="result-value" id="timeout-height">N/A</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Status</div>
                                <div class="result-value" id="timeout-status-text">Load HTLC data first</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" id="load-refund-data-btn">📋 Load HTLC Data</button>
                    </div>
                    
                    <div>
                        <form id="refund-form" class="hidden">
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Sender Wallet (for refund):</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-refund-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="refund-wallet-dropdown">
                                    <select id="refund-sender-wallet-select" name="refund-sender-wallet" required>
                                        <option value="">Select sender wallet...</option>
                                    </select>
                                    <small style="color: #6c757d;">Must be the original sender wallet from HTLC creation</small>
                                </div>
                                
                                <div id="refund-manual-input" class="hidden">
                                    <input type="text" id="refund-wif-manual" placeholder="Paste sender private key (WIF)..." style="margin-bottom: 10px;">
                                    <input type="text" id="refund-address-manual" placeholder="Paste refund destination address..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter original sender's WIF and destination address</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Refund Destination Address:</label>
                                <input type="text" id="refund-address" placeholder="tb1q..." readonly>
                                <small style="color: #6c757d;">Funds will be sent back to this address</small>
                            </div>
                            
                            <button type="submit" class="btn btn-danger">Create Refund Transaction</button>
                        </form>
                    </div>
                </div>
                
                <div id="refund-results" class="result-section hidden">
                    <h3>💰 Refund Transaction Created</h3>
                    <div class="result-item">
                        <div class="result-label">Refund Transaction</div>
                        <div class="result-value">
                            <a href="#" target="_blank" class="tx-link" id="refund-tx-link"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading" class="loading hidden">
            <div>⏳ Processing transaction...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        // Check QRious library loading
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof QRious !== 'undefined') {
                console.log('✅ QRious library loaded successfully');
                window.qrReady = true;
            } else {
                console.error('❌ QRious library failed to load');
                window.qrReady = false;
            }
        });
    </script>
    <script>
        let currentTab = 'sender';
        let htlcData = null;
        let availableWallets = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Load saved wallets first
            loadSavedWallets();
            // Initialize network status
            await updateNetworkStatus();
            await updateCurrentBlock();
            
            // Tab functionality
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.closest('.tab-btn').getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Wallet selection handlers
            document.getElementById('sender-wallet-select')?.addEventListener('change', handleSenderWalletChange);
            document.getElementById('receiver-wallet-select')?.addEventListener('change', handleReceiverWalletChange);
            document.getElementById('receiver-claim-wallet-select')?.addEventListener('change', handleReceiverClaimWalletChange);
            document.getElementById('refund-sender-wallet-select')?.addEventListener('change', handleRefundSenderWalletChange);
            
            // Toggle handlers for manual input
            document.getElementById('toggle-sender-input')?.addEventListener('click', () => toggleInputMode('sender'));
            document.getElementById('toggle-receiver-input')?.addEventListener('click', () => toggleInputMode('receiver'));
            document.getElementById('toggle-receiver-claim-input')?.addEventListener('click', () => toggleInputMode('receiver-claim'));
            document.getElementById('toggle-refund-input')?.addEventListener('click', () => toggleInputMode('refund'));
            
            // Manual input handlers
            document.getElementById('receiver-wif-manual')?.addEventListener('input', handleReceiverWifInput);
            document.getElementById('refund-address-manual')?.addEventListener('input', handleRefundAddressInput);
            
            // Form handlers
            const senderForm = document.getElementById('sender-form');
            console.log('Sender form found:', !!senderForm);
            senderForm?.addEventListener('submit', handleSenderForm);
            
            const receiverForm = document.getElementById('receiver-form');
            console.log('Receiver form found:', !!receiverForm);
            receiverForm?.addEventListener('submit', handleReceiverForm);
            
            const refundForm = document.getElementById('refund-form');
            console.log('Refund form found:', !!refundForm);
            refundForm?.addEventListener('submit', handleRefundForm);

            // Action buttons
            document.getElementById('scan-qr-btn')?.addEventListener('click', scanQRCode);
            document.getElementById('paste-data-btn')?.addEventListener('click', pasteHTLCData);
            
            // Camera scanner controls
            document.getElementById('start-scan-btn')?.addEventListener('click', startScanning);
            document.getElementById('stop-scan-btn')?.addEventListener('click', stopScanning);
            document.getElementById('test-qr-btn')?.addEventListener('click', testQRScanner);
            document.getElementById('load-refund-data-btn')?.addEventListener('click', loadRefundData);
            document.getElementById('refresh-wallets-btn')?.addEventListener('click', refreshWallets);
            
            // Copy HTLC data button
            document.getElementById('copy-htlc-data')?.addEventListener('click', copyHTLCData);
            document.getElementById('test-form-btn')?.addEventListener('click', testForm);
            document.getElementById('fill-test-data-btn')?.addEventListener('click', fillTestData);
            document.getElementById('debug-wallets-btn')?.addEventListener('click', debugWalletData);
            document.getElementById('refresh-balances-btn')?.addEventListener('click', async () => {
                showLoading(true);
                await refreshAllWalletBalances();
                showLoading(false);
                showToast('💰 All wallet balances updated!');
            });

            // Auto-update current block height
            setInterval(updateCurrentBlock, 30000);
        });

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`)?.classList.add('active');
        }

        async function updateNetworkStatus() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                const statusEl = document.getElementById('network-status');
                
                if (health.status === 'healthy') {
                    statusEl.className = 'network-status healthy';
                    statusEl.textContent = `✅ Network Healthy - Block ${health.network.blockHeight}`;
                } else {
                    statusEl.className = 'network-status unhealthy';
                    statusEl.textContent = '❌ Network Issues';
                }
            } catch (error) {
                const statusEl = document.getElementById('network-status');
                statusEl.className = 'network-status unhealthy';
                statusEl.textContent = '❌ Connection Error';
            }
        }

        async function updateCurrentBlock() {
            try {
                const response = await fetch('/api/block-height');
                const data = await response.json();
                document.getElementById('current-block').textContent = data.blockHeight;
                document.getElementById('current-height').textContent = data.blockHeight;
                
                // Auto-suggest timeout block (100 blocks in future)
                const timeoutSuggestion = data.blockHeight + 100;
                const timeoutInput = document.getElementById('refund-locktime-input');
                if (timeoutInput && !timeoutInput.value) {
                    timeoutInput.value = timeoutSuggestion;
                }
            } catch (error) {
                console.error('Failed to get current block:', error);
            }
        }

        async function loadSavedWallets() {
            const stored = localStorage.getItem('bitcoin-wallets');
            availableWallets = stored ? JSON.parse(stored) : [];
            
            // Register all wallets with the server for HTLC use
            if (availableWallets.length > 0) {
                console.log('Registering wallets with server for HTLC use...');
                for (const wallet of availableWallets) {
                    try {
                        await registerWalletForHTLC(wallet.address, wallet.privateKey, wallet.name);
                    } catch (error) {
                        console.log(`Failed to register ${wallet.name}:`, error);
                    }
                }
            }
            
            // Populate all wallet dropdowns
            populateWalletDropdowns();
            displayWalletList();
            
            // Automatically refresh balances when wallets are loaded
            if (availableWallets.length > 0) {
                await refreshAllWalletBalances();
                showToast('🔄 Wallets registered and balances refreshed', 'success');
            } else {
                showToast('ℹ️ No wallets found. Create wallets in the Wallet page first.', 'info');
            }
        }

        async function refreshWallets() {
            loadSavedWallets();
            await refreshAllWalletBalances();
            showToast('🔄 Wallets and balances refreshed');
        }
        
        async function refreshAllWalletBalances() {
            if (availableWallets.length === 0) return;
            
            try {
                const addresses = availableWallets.map(w => w.address);
                const response = await fetch('/api/wallet/refresh-balances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ addresses })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update wallet balances in localStorage
                    result.balances.forEach(balanceData => {
                        const wallet = availableWallets.find(w => w.address === balanceData.address);
                        if (wallet && !balanceData.error) {
                            const oldBalance = wallet.balance;
                            wallet.balance = balanceData.balance;
                            console.log(`💰 Updated ${wallet.name}: ${oldBalance} → ${balanceData.balance} sats`);
                        }
                    });
                    
                    // Save updated wallets and refresh display
                    localStorage.setItem('bitcoin-wallets', JSON.stringify(availableWallets));
                    populateWalletDropdowns();
                    displayWalletList();
                    
                    console.log('✅ Updated wallet balances:', result.balances);
                } else {
                    console.error('Failed to refresh balances');
                }
            } catch (error) {
                console.error('Error refreshing balances:', error);
            }
        }
        
        function debugWalletData() {
            console.log('=== WALLET DEBUG INFO ===');
            const stored = localStorage.getItem('bitcoin-wallets');
            console.log('Raw localStorage data:', stored);
            if (stored) {
                const wallets = JSON.parse(stored);
                console.log('Parsed wallets:', wallets);
                wallets.forEach((wallet, index) => {
                    console.log(`Wallet ${index}:`, {
                        name: wallet.name,
                        address: wallet.address,
                        publicKey: wallet.publicKey,
                        publicKeyLength: wallet.publicKey?.length,
                        addressType: wallet.addressType
                    });
                });
            } else {
                console.log('No wallets found in localStorage');
            }
            console.log('=== END WALLET DEBUG ===');
        }
        
        async function registerWalletForHTLC(address, privateKey, name) {
            try {
                const response = await fetch('/api/wallet/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, privateKey, name })
                });
                
                const result = await response.json();
                if (response.ok) {
                    console.log('✅ Wallet registered:', result);
                    showToast(`✅ Registered: ${name || address.slice(-8)}`);
                    return result;
                } else {
                    showError(result.error || 'Failed to register wallet');
                    return null;
                }
            } catch (error) {
                showError('Failed to register wallet: ' + error.message);
                return null;
            }
        }

        function displayWalletList() {
            const walletListDiv = document.getElementById('wallet-list');
            const noWalletsMsg = document.getElementById('no-wallets-message');
            
            if (availableWallets.length === 0) {
                noWalletsMsg.style.display = 'block';
                return;
            }
            
            noWalletsMsg.style.display = 'none';
            
            // Clear existing wallet cards
            walletListDiv.innerHTML = '';
            
            availableWallets.forEach(wallet => {
                const walletCard = document.createElement('div');
                walletCard.className = 'result-item';
                walletCard.innerHTML = `
                    <div class="result-label">${wallet.name} (${wallet.addressType.toUpperCase()})</div>
                    <div class="result-value">
                        <strong>Address:</strong> ${wallet.address}<br>
                        <strong>Balance:</strong> ${wallet.balance} satoshis<br>
                        <strong>Created:</strong> ${new Date(wallet.created).toLocaleDateString()}
                    </div>
                `;
                walletListDiv.appendChild(walletCard);
            });
        }

        function populateWalletDropdowns() {
            const selectors = [
                'sender-wallet-select',
                'receiver-wallet-select', 
                'receiver-claim-wallet-select',
                'refund-sender-wallet-select'
            ];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    // Clear existing options except first
                    select.innerHTML = select.firstElementChild.outerHTML;
                    
                    // Add wallet options
                    availableWallets.forEach(wallet => {
                        const option = document.createElement('option');
                        option.value = wallet.address;
                        option.textContent = `${wallet.name} (${wallet.address.slice(0, 10)}...${wallet.address.slice(-6)}) - ${wallet.balance} sats`;
                        option.dataset.wallet = JSON.stringify(wallet);
                        select.appendChild(option);
                    });
                }
            });
        }

        function handleSenderWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                showToast(`📝 Sender: ${wallet.name} (${wallet.balance} sats)`);
            }
        }

        function handleReceiverWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                showToast(`📝 Receiver: ${wallet.name}`);
            }
        }

        function handleReceiverClaimWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                document.getElementById('claim-address').value = wallet.address;
                showToast(`📝 Claim destination: ${wallet.name}`);
            }
        }

        function handleRefundSenderWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                document.getElementById('refund-address').value = wallet.address;
                showToast(`📝 Refund destination: ${wallet.name}`);
            }
        }

        function toggleInputMode(type) {
            const toggleMaps = {
                'sender': {
                    dropdown: 'sender-wallet-dropdown',
                    manual: 'sender-manual-input',
                    button: 'toggle-sender-input'
                },
                'receiver': {
                    dropdown: 'receiver-wallet-dropdown', 
                    manual: 'receiver-manual-input',
                    button: 'toggle-receiver-input'
                },
                'receiver-claim': {
                    dropdown: 'receiver-claim-dropdown',
                    manual: 'receiver-claim-manual-input', 
                    button: 'toggle-receiver-claim-input'
                },
                'refund': {
                    dropdown: 'refund-wallet-dropdown',
                    manual: 'refund-manual-input',
                    button: 'toggle-refund-input'
                }
            };
            
            const map = toggleMaps[type];
            if (!map) return;
            
            const dropdownDiv = document.getElementById(map.dropdown);
            const manualDiv = document.getElementById(map.manual);
            const toggleBtn = document.getElementById(map.button);
            
            const isManualMode = !manualDiv.classList.contains('hidden');
            
            if (isManualMode) {
                // Switch to dropdown mode
                manualDiv.classList.add('hidden');
                dropdownDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Manual Input';
            } else {
                // Switch to manual mode
                dropdownDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Use Wallets';
            }
        }

        function getSelectedWallet(selectId) {
            const select = document.getElementById(selectId);
            const selectedOption = select.options[select.selectedIndex];
            return selectedOption?.dataset.wallet ? JSON.parse(selectedOption.dataset.wallet) : null;
        }

        function handleReceiverWifInput() {
            const wif = document.getElementById('receiver-wif-manual').value;
            if (wif) {
                generateP2WPKHAddressFromWIF(wif).then(address => {
                    if (address) {
                        document.getElementById('claim-address').value = address;
                    }
                });
            }
        }

        function handleRefundAddressInput() {
            const address = document.getElementById('refund-address-manual').value;
            if (address) {
                document.getElementById('refund-address').value = address;
            }
        }

        async function generateP2WPKHAddressFromWIF(wif) {
            try {
                const response = await fetch('/api/wallet/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'temp', privateKey: wif })
                });
                const wallet = await response.json();
                return wallet.address;
            } catch (error) {
                console.error('Error generating address from WIF:', error);
                return null;
            }
        }

        async function handleSenderForm(e) {
            console.log('handleSenderForm called');
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Check if using manual input mode
            const senderManualMode = !document.getElementById('sender-manual-input').classList.contains('hidden');
            const receiverManualMode = !document.getElementById('receiver-manual-input').classList.contains('hidden');
            
            console.log('Manual modes:', { senderManualMode, receiverManualMode });
            
            let senderWif, receiverPubkey, senderWallet = null, receiverWallet = null;
            
            if (senderManualMode) {
                senderWif = document.getElementById('sender-wif-manual').value;
                if (!senderWif) {
                    showError('Please enter sender private key');
                    return;
                }
            } else {
                senderWallet = getSelectedWallet('sender-wallet-select');
                if (!senderWallet) {
                    showError('Please select a sender wallet');
                    return;
                }
                console.log('Full sender wallet object:', senderWallet);
                senderWif = senderWallet.privateKey;
                console.log('Extracted sender WIF:', senderWif?.slice(0, 10) + '...');
            }
            
            let receiverAddress;
            if (receiverManualMode) {
                receiverAddress = document.getElementById('receiver-address-manual').value;
                if (!receiverAddress) {
                    showError('Please enter receiver address');
                    return;
                }
                // For manual address input, we don't have the public key
                receiverPubkey = null;
            } else {
                receiverWallet = getSelectedWallet('receiver-wallet-select');
                if (!receiverWallet) {
                    showError('Please select a receiver wallet');
                    return;
                }
                console.log('Full receiver wallet object:', receiverWallet);
                console.log('Available wallet fields:', Object.keys(receiverWallet));
                console.log('Wallet publicKey field:', receiverWallet.publicKey);
                console.log('Wallet address field:', receiverWallet.address);
                receiverAddress = receiverWallet.address;
                receiverPubkey = receiverWallet.publicKey;
                console.log('Using receiver address:', receiverAddress);
                console.log('Using receiver public key:', receiverPubkey);
                console.log('Public key type:', typeof receiverPubkey, 'length:', receiverPubkey?.length);
            }
            
            // Validate data before sending request
            if (!receiverManualMode) {
                // Wallet selection mode - must have public key
                if (!receiverPubkey || typeof receiverPubkey !== 'string') {
                    showError(`No receiver public key found in wallet data. Please check wallet or use manual input.`);
                    return;
                }
                
                if (receiverPubkey.length !== 66) {
                    showError(`Invalid receiver public key format. Expected 66-character hex, got: ${receiverPubkey?.length || 0} characters. Value: "${receiverPubkey}"`);
                    return;
                }
            } else {
                // Manual mode - validate address format
                if (!receiverAddress.startsWith('tb1')) {
                    showError('Please enter a valid testnet address starting with "tb1"');
                    return;
                }
            }
            
            try {
                showLoading(true);
                document.getElementById('sender-status').className = 'status-indicator active';
                
                const requestData = {
                    senderWif: senderManualMode ? senderWif : null,
                    senderAddress: senderManualMode ? null : senderWallet.address,
                    receiverAddress: receiverAddress,
                    receiverPublicKey: receiverPubkey,
                    amount: parseInt(formData.get('amount')),
                    refundLocktime: parseInt(formData.get('refund-locktime'))
                };
                
                console.log('Sending request with:', {
                    ...requestData,
                    senderWif: senderWif?.slice(0, 10) + '...'
                });
                
                const response = await fetch('/api/create-sender-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    htlcData = {
                        ...result,
                        senderWallet: senderWallet,
                        receiverWallet: receiverWallet,
                        manualMode: { sender: senderManualMode, receiver: receiverManualMode }
                    };
                    displaySenderResults(result);
                    document.getElementById('sender-status').className = 'status-indicator completed';
                    showToast('✅ HTLC created and funded');
                    
                    // Refresh wallet balances after transaction
                    setTimeout(() => {
                        refreshAllWalletBalances();
                        showToast('🔄 Balances updated automatically');
                    }, 5000); // Wait 5 seconds for transaction to confirm
                } else {
                    document.getElementById('sender-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to create HTLC');
                }
            } catch (error) {
                document.getElementById('sender-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleReceiverForm(e) {
            e.preventDefault();
            
            if (!htlcData) {
                showError('No HTLC data loaded. Scan QR code or paste data first.');
                return;
            }
            
            // Check if using manual input mode
            const manualMode = !document.getElementById('receiver-claim-manual-input').classList.contains('hidden');
            let receiverWif;
            
            if (manualMode) {
                receiverWif = document.getElementById('receiver-wif-manual').value;
                if (!receiverWif) {
                    showError('Please enter receiver private key');
                    return;
                }
            } else {
                const receiverWallet = getSelectedWallet('receiver-claim-wallet-select');
                if (!receiverWallet) {
                    showError('Please select a receiver wallet');
                    return;
                }
                receiverWif = receiverWallet.privateKey;
            }
            
            try {
                showLoading(true);
                document.getElementById('receiver-status').className = 'status-indicator active';
                
                const response = await fetch('/api/create-receiver-claim-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txoData: htlcData,
                        preimage: htlcData.preimage,
                        receiverWif: receiverWif
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayReceiverResults(result);
                    document.getElementById('receiver-status').className = 'status-indicator completed';
                    showToast('✅ HTLC funds claimed successfully');
                } else {
                    document.getElementById('receiver-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to claim HTLC');
                }
            } catch (error) {
                document.getElementById('receiver-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleRefundForm(e) {
            e.preventDefault();
            
            if (!htlcData) {
                showError('No HTLC data loaded. Load HTLC data first.');
                return;
            }
            
            // Check if using manual input mode
            const manualMode = !document.getElementById('refund-manual-input').classList.contains('hidden');
            let senderWif;
            
            if (manualMode) {
                senderWif = document.getElementById('refund-wif-manual').value;
                if (!senderWif) {
                    showError('Please enter sender private key');
                    return;
                }
            } else {
                const senderWallet = getSelectedWallet('refund-sender-wallet-select');
                if (!senderWallet) {
                    showError('Please select the sender wallet for refund');
                    return;
                }
                senderWif = senderWallet.privateKey;
            }
            
            try {
                showLoading(true);
                document.getElementById('refund-status').className = 'status-indicator active';
                
                const response = await fetch('/api/create-sender-refund-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txoData: htlcData,
                        senderWif: senderWif
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayRefundResults(result);
                    document.getElementById('refund-status').className = 'status-indicator completed';
                    showToast('✅ HTLC refund processed');
                } else {
                    document.getElementById('refund-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to process refund');
                }
            } catch (error) {
                document.getElementById('refund-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displaySenderResults(result) {
            const resultsDiv = document.getElementById('sender-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('htlc-address').textContent = result.taprootAddress;
            document.getElementById('preimage-display').textContent = result.preimage;
            document.getElementById('funding-tx-link').href = result.explorerUrl || '#';
            document.getElementById('funding-tx-link').textContent = result.txid;
            
            // Add wallet information to results
            if (htlcData.senderWallet && htlcData.receiverWallet) {
                const additionalInfo = document.createElement('div');
                additionalInfo.innerHTML = `
                    <div class="result-item">
                        <div class="result-label">Sender Wallet</div>
                        <div class="result-value">${htlcData.senderWallet.name} (${htlcData.senderWallet.address})</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Receiver Wallet</div>
                        <div class="result-value">${htlcData.receiverWallet.name} (${htlcData.receiverWallet.address})</div>
                    </div>
                `;
                resultsDiv.appendChild(additionalInfo);
            }
            
            // Store HTLC data for copying
            window.currentHTLCData = {
                txid: result.txid,
                vout: result.vout || 0,
                value: result.value || result.amount,
                preimage: result.preimage,
                senderPublicKey: result.senderPublicKey,
                refundTimeLock: result.refundTimeLock,
                receiverPublicKey: result.receiverPublicKey,
                htlcAddress: result.taprootAddress,
                receiverAddress: result.receiverAddress,
                senderWallet: htlcData.senderWallet,
                receiverWallet: htlcData.receiverWallet
            };
            
            // Generate QR code
            const qrData = JSON.stringify(window.currentHTLCData);
            console.log('Generating QR code with data:', qrData);
            
            // Clear any previous QR code
            const canvas = document.getElementById('qrcode-canvas');
            if (canvas) {
                canvas.getContext('2d')?.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // Generate QR code using QRious library
            const generateQR = () => {
                console.log('=== QR GENERATION DEBUG ===');
                console.log('Canvas element:', !!canvas);
                console.log('QRious available:', typeof QRious);
                console.log('Window qrReady:', window.qrReady);
                
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }
                
                if (typeof QRious !== 'undefined') {
                    console.log('Using QRious library, generating...');
                    try {
                        // Use simpler data for QR code
                        const simpleData = JSON.stringify({
                            txid: result.txid,
                            vout: result.vout || 0,
                            value: result.value || result.amount,
                            preimage: result.preimage,
                            refundTimeLock: result.refundTimeLock,
                            receiverAddress: result.receiverAddress
                        });
                        
                        console.log('QR data to encode:', simpleData);
                        console.log('QR data length:', simpleData.length);
                        
                        // Create QRious instance
                        const qr = new QRious({
                            element: canvas,
                            value: simpleData,
                            size: 200,
                            level: 'M'
                        });
                        
                        console.log('✅ QR code generated with QRious');
                        canvas.style.display = 'block';
                        
                        // Clear any error messages
                        const existingError = canvas.parentNode.querySelector('.qr-error');
                        if (existingError) {
                            existingError.remove();
                        }
                        
                    } catch (err) {
                        console.error('QRious generation error:', err);
                        showQRError('QR generation failed: ' + err.message);
                    }
                } else {
                    console.error('QRious library not available');
                    showQRError('QRious library not loaded - trying fallback...');
                    
                    // Try loading QRious dynamically as fallback
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/qrious@4.0.2/dist/qrious.min.js';
                    script.onload = () => {
                        console.log('✅ QRious loaded dynamically');
                        generateQR();
                    };
                    script.onerror = () => {
                        showQRError('Failed to load QR library');
                    };
                    document.head.appendChild(script);
                }
            };
            
            // Helper function to show QR errors
            const showQRError = (message) => {
                const qrContainer = canvas.parentNode;
                let errorDiv = qrContainer.querySelector('.qr-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'qr-error';
                    errorDiv.style.color = '#dc3545';
                    errorDiv.style.padding = '10px';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.background = '#f8d7da';
                    errorDiv.style.borderRadius = '5px';
                    qrContainer.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
                canvas.style.display = 'none';
            };
            
            // Generate immediately if library ready, otherwise wait
            if (window.qrReady) {
                generateQR();
            } else {
                setTimeout(generateQR, 500);
            }
        }

        function displayReceiverResults(result) {
            const resultsDiv = document.getElementById('receiver-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('claim-tx-link').href = result.explorerUrl || '#';
            document.getElementById('claim-tx-link').textContent = result.txid;
        }

        function displayRefundResults(result) {
            const resultsDiv = document.getElementById('refund-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('refund-tx-link').href = result.explorerUrl || '#';
            document.getElementById('refund-tx-link').textContent = result.txid;
        }

        // Camera QR scanning implementation
        let videoStream = null;
        let isScanning = false;

        async function scanQRCode() {
            console.log('Scan QR Code clicked - starting camera');
            
            const scannerDiv = document.getElementById('qr-scanner');
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            
            if (!scannerDiv || !startBtn || !stopBtn) {
                console.error('QR scanner elements not found');
                if (confirm('Camera scanner not available. Click OK to paste HTLC data manually.')) {
                    pasteHTLCData();
                }
                return;
            }
            
            if (isScanning) {
                stopScanning();
                return;
            }
            
            try {
                scannerDiv.classList.remove('hidden');
                await startScanning();
            } catch (error) {
                console.error('Failed to start camera:', error);
                showToast('Camera access failed: ' + error.message + '. Please try pasting HTLC data manually.', 'error');
                scannerDiv.classList.add('hidden');
                pasteHTLCData();
            }
        }

        async function startScanning() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('qr-video');
                
                if (!video) {
                    throw new Error('Video element not found');
                }
                
                video.srcObject = videoStream;
                video.play();
                
                isScanning = true;
                document.getElementById('start-scan-btn').style.display = 'none';
                document.getElementById('stop-scan-btn').style.display = 'inline-block';
                
                // Start QR detection
                requestAnimationFrame(scanFrame);
                
            } catch (error) {
                throw new Error('Camera not accessible: ' + error.message);
            }
        }

        function stopScanning() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            isScanning = false;
            document.getElementById('qr-scanner').classList.add('hidden');
            document.getElementById('start-scan-btn').style.display = 'inline-block';
            document.getElementById('stop-scan-btn').style.display = 'none';
        }

        function scanFrame() {
            if (!isScanning) return;
            
            const video = document.getElementById('qr-video');
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // Make sure canvas has proper dimensions
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    console.log('Canvas dimensions set to:', canvas.width, 'x', canvas.height);
                }
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Debug logging every 60 frames (about 1 second)
                if (Math.random() < 0.016) {
                    console.log('Scanning frame:', canvas.width, 'x', canvas.height, 'jsQR available:', !!window.jsQR);
                }
                
                if (window.jsQR) {
                    try {
                        // Try multiple inversion attempts for better detection
                        const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'attemptBoth'
                        });
                        
                        if (code) {
                            console.log('🎯 QR Code detected:', code.data);
                            console.log('QR Code location:', code.location);
                            
                            // Visual feedback - draw a box around the detected QR code
                            ctx.strokeStyle = '#00ff00';
                            ctx.lineWidth = 4;
                            ctx.strokeRect(
                                code.location.topLeftCorner.x,
                                code.location.topLeftCorner.y,
                                code.location.topRightCorner.x - code.location.topLeftCorner.x,
                                code.location.bottomLeftCorner.y - code.location.topLeftCorner.y
                            );
                            
                            // Make canvas visible briefly to show detection
                            canvas.style.position = 'absolute';
                            canvas.style.top = video.offsetTop + 'px';
                            canvas.style.left = video.offsetLeft + 'px';
                            canvas.style.zIndex = '10';
                            canvas.classList.remove('hidden');
                            
                            setTimeout(() => {
                                canvas.classList.add('hidden');
                            }, 1000);
                            
                            handleScannedQRCode(code.data);
                            return; // Stop scanning
                        }
                    } catch (error) {
                        console.error('jsQR scan error:', error);
                    }
                } else {
                    console.error('jsQR library not available');
                }
            } else {
                // Debug video state
                if (Math.random() < 0.01) {
                    console.log('Video not ready, readyState:', video.readyState);
                }
            }
            
            requestAnimationFrame(scanFrame);
        }

        function handleScannedQRCode(qrData) {
            stopScanning();
            
            try {
                // Try to parse as JSON first
                const parsedData = JSON.parse(qrData);
                
                if (parsedData.txid && parsedData.vout !== undefined && parsedData.value) {
                    console.log('Valid HTLC data detected:', parsedData);
                    htlcData = parsedData;
                    
                    // Auto-select receiver wallet if available
                    const receiverWallets = getWalletsFromStorage();
                    if (receiverWallets && receiverWallets.length > 0) {
                        autoSelectReceiverWallet(receiverWallets);
                    }
                    
                    showToast('QR Code scanned successfully! HTLC data loaded.', 'success');
                    updateClaimDisplay();
                } else {
                    showToast('QR code contains data but not valid HTLC format. Please scan a valid HTLC QR code.', 'error');
                }
            } catch (error) {
                // If not JSON, treat as plain text
                console.log('QR code contains non-JSON data:', qrData);
                showToast('QR code scanned but contains invalid data format. Expected HTLC JSON data.', 'error');
            }
        }
        
        function updateClaimDisplay() {
            if (!htlcData) return;
            
            // Hide the Load HTLC Data section
            const loadSection = document.querySelector('#receiver-tab .htlc-grid > div:first-child');
            if (loadSection) {
                // Hide the buttons and scanner, but keep the HTLC data display
                const scanBtn = document.getElementById('scan-qr-btn');
                const pasteBtn = document.getElementById('paste-data-btn');
                const scanner = document.getElementById('qr-scanner');
                
                if (scanBtn) scanBtn.style.display = 'none';
                if (pasteBtn) pasteBtn.style.display = 'none';
                if (scanner) scanner.classList.add('hidden');
                
                // Hide the h3 title "Load HTLC Data"
                const h3Title = loadSection.querySelector('h3');
                if (h3Title) h3Title.style.display = 'none';
            }
            
            // Show HTLC contract details
            const htlcDisplay = document.getElementById('htlc-data-display');
            if (htlcDisplay) {
                htlcDisplay.classList.remove('hidden');
                htlcDisplay.innerHTML = `
                    <h4>HTLC Contract Details</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #28a745;">
                        <p><strong>Transaction ID:</strong> ${htlcData.txid}</p>
                        <p><strong>Output Index:</strong> ${htlcData.vout}</p>
                        <p><strong>Amount:</strong> ${(htlcData.value || htlcData.amount).toLocaleString()} satoshis</p>
                        <p><strong>Contract Address:</strong> ${htlcData.receiverAddress || htlcData.taprootAddress || 'N/A'}</p>
                        <p><strong>Refund Locktime:</strong> Block ${htlcData.refundTimeLock}</p>
                        ${htlcData.preimage ? `<p><strong>Preimage:</strong> ${htlcData.preimage.slice(0, 20)}...</p>` : ''}
                    </div>
                `;
            }
            
            // Show a simple claim button instead of the complex form
            const claimSection = document.querySelector('#receiver-tab .htlc-grid > div:last-child');
            if (claimSection) {
                claimSection.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <button type="button" class="btn btn-success" id="simple-claim-btn" style="font-size: 18px; padding: 15px 30px;">
                            💰 Claim HTLC Funds
                        </button>
                        <p style="color: #6c757d; margin-top: 10px; font-size: 14px;">
                            Click to claim the funds from this HTLC contract
                        </p>
                    </div>
                `;
                
                // Add event listener for the simple claim button
                document.getElementById('simple-claim-btn')?.addEventListener('click', handleSimpleClaim);
            }
        }

        async function handleSimpleClaim() {
            if (!htlcData) {
                showToast('No HTLC data loaded. Please scan or paste HTLC data first.', 'error');
                return;
            }
            
            // Get available wallets
            const wallets = getWalletsFromStorage();
            if (!wallets || wallets.length === 0) {
                showToast('No wallets found. Please create a wallet first.', 'error');
                return;
            }
            
            // Auto-select the first available wallet for claiming
            const receiverWallet = wallets[0];
            
            try {
                showToast('Claiming HTLC funds...', 'info');
                
                const claimData = {
                    txoData: {
                        txid: htlcData.txid,
                        vout: htlcData.vout,
                        value: htlcData.value || htlcData.amount,
                        senderPublicKey: htlcData.senderPublicKey,
                        refundTimeLock: htlcData.refundTimeLock
                    },
                    preimage: htlcData.preimage,
                    receiverWif: receiverWallet.privateKey
                };
                
                console.log('Claiming HTLC with data:', claimData);
                
                const response = await fetch('/api/create-receiver-claim-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(claimData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to claim HTLC funds');
                }
                
                console.log('✅ HTLC claimed successfully:', result);
                
                // Show success message
                showToast(`✅ HTLC funds claimed successfully! TX: ${result.broadcastTxid}`, 'success');
                
                // Show claim results
                displayClaimResults(result);
                
            } catch (error) {
                console.error('Claim error:', error);
                showToast('Failed to claim HTLC funds: ' + error.message, 'error');
            }
        }
        
        function displayClaimResults(result) {
            const claimSection = document.querySelector('#receiver-tab .htlc-grid > div:last-child');
            if (claimSection) {
                const txid = result.broadcastTxid || result.txid;
                const mempoolUrl = result.explorerUrl || `https://mempool.space/testnet/tx/${txid}`;
                
                claimSection.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="background: #d1e7dd; padding: 25px; border-radius: 12px; border: 2px solid #badbcc; color: #0f5132; text-align: center;">
                            <h4 style="margin-bottom: 20px; color: #198754;">✅ HTLC Funds Claimed Successfully!</h4>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c3e6cb;">
                                <p style="margin: 5px 0; font-weight: 600;">Transaction Status:</p>
                                <p style="margin: 5px 0; color: #198754; font-size: 16px;">✅ Broadcasted to Network</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c3e6cb;">
                                <p style="margin: 5px 0; font-weight: 600;">Transaction ID:</p>
                                <p style="font-family: monospace; word-break: break-all; font-size: 12px; margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 4px;">${txid}</p>
                                
                                <a href="${mempoolUrl}" target="_blank" 
                                   style="display: inline-block; background: #0d6efd; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 10px;">
                                    🔗 View on Mempool.space
                                </a>
                            </div>
                            
                            <p style="margin-top: 20px; font-size: 14px; color: #6c757d;">
                                Your HTLC funds have been successfully claimed and sent to your wallet!<br>
                                The transaction is now being confirmed on the Bitcoin testnet.
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        function testQRScanner() {
            console.log('🔧 Testing QR Scanner components...');
            console.log('jsQR available:', !!window.jsQR);
            console.log('getUserMedia available:', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
            
            const video = document.getElementById('qr-video');
            const canvas = document.getElementById('qr-canvas');
            
            console.log('Video element:', !!video);
            console.log('Canvas element:', !!canvas);
            
            if (video) {
                console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                console.log('Video readyState:', video.readyState);
            }
            
            if (canvas) {
                console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
            }
            
            // Test with fake QR data
            const testData = JSON.stringify({
                txid: "test123",
                vout: 0,
                value: 10000,
                preimage: "test_preimage",
                refundTimeLock: 123456
            });
            
            console.log('Testing with fake QR data:', testData);
            handleScannedQRCode(testData);
        }

        function pasteHTLCData() {
            const pastedData = prompt('Paste HTLC transaction data (JSON):');
            if (pastedData && pastedData.trim()) {
                try {
                    console.log('Pasted HTLC data:', pastedData);
                    htlcData = JSON.parse(pastedData.trim());
                    console.log('Parsed HTLC data:', htlcData);
                    
                    updateClaimDisplay();
                    
                    // Auto-select receiver wallet if it exists in saved wallets
                    if (htlcData.receiverWallet) {
                        const receiverSelect = document.getElementById('receiver-claim-wallet-select');
                        const matchingOption = Array.from(receiverSelect.options).find(option => 
                            option.value === htlcData.receiverWallet.address
                        );
                        if (matchingOption) {
                            receiverSelect.value = matchingOption.value;
                            document.getElementById('claim-address').value = htlcData.receiverWallet.address;
                            showToast(`🎯 Auto-selected receiver wallet: ${htlcData.receiverWallet.name}`);
                        }
                    }
                    
                    // For manual address mode, set the claim address to the receiver address from HTLC data
                    if (htlcData.receiverAddress && !htlcData.receiverWallet) {
                        document.getElementById('claim-address').value = htlcData.receiverAddress;
                        showToast('📋 Set claim address from HTLC data');
                    }
                    
                    document.getElementById('receiver-form').classList.remove('hidden');
                    showToast('✅ HTLC data loaded successfully');
                } catch (error) {
                    console.error('Parse error:', error);
                    showError('Invalid HTLC data format. Please ensure it\'s valid JSON from the HTLC creation step.');
                }
            } else if (pastedData !== null) {
                showError('No data pasted. Please copy the HTLC data first.');
            }
        }

        function loadRefundData() {
            const pastedData = prompt('Paste HTLC transaction data (JSON):');
            if (pastedData) {
                try {
                    htlcData = JSON.parse(pastedData);
                    updateTimeoutStatus();
                    
                    // Auto-select sender wallet if it exists in saved wallets
                    if (htlcData.senderWallet) {
                        const senderSelect = document.getElementById('refund-sender-wallet-select');
                        const matchingOption = Array.from(senderSelect.options).find(option => 
                            option.value === htlcData.senderWallet.address
                        );
                        if (matchingOption) {
                            senderSelect.value = matchingOption.value;
                            document.getElementById('refund-address').value = htlcData.senderWallet.address;
                        }
                    }
                    
                    document.getElementById('refund-form').classList.remove('hidden');
                    showToast('✅ HTLC data loaded for refund');
                } catch (error) {
                    showError('Invalid HTLC data format. Expected JSON.');
                }
            }
        }

        function displayHTLCData() {
            if (!htlcData) return;
            
            const display = document.getElementById('htlc-data-display');
            display.classList.remove('hidden');
            
            document.getElementById('htlc-info').innerHTML = `
                <div class="result-item">
                    <div class="result-label">HTLC Address</div>
                    <div class="result-value">${htlcData.htlcAddress || htlcData.taprootAddress}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Amount</div>
                    <div class="result-value">${htlcData.value} satoshis</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Timeout Block</div>
                    <div class="result-value">${htlcData.refundTimeLock}</div>
                </div>
            `;
        }

        function updateTimeoutStatus() {
            if (!htlcData) return;
            
            document.getElementById('timeout-height').textContent = htlcData.refundTimeLock;
            
            const currentBlock = parseInt(document.getElementById('current-height').textContent);
            const timeoutBlock = htlcData.refundTimeLock;
            
            const statusText = document.getElementById('timeout-status-text');
            if (currentBlock >= timeoutBlock) {
                statusText.textContent = '✅ Timeout reached - Refund available';
                statusText.style.color = '#198754';
            } else {
                const blocksRemaining = timeoutBlock - currentBlock;
                statusText.textContent = `⏰ ${blocksRemaining} blocks until timeout`;
                statusText.style.color = '#856404';
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function testForm() {
            console.log('Test form button clicked');
            showToast('🧪 Form test - button works!');
        }

        async function fillTestData() {
            console.log('Filling test data');
            
            // Switch to manual input mode for both
            if (document.getElementById('sender-manual-input').classList.contains('hidden')) {
                toggleInputMode('sender');
            }
            if (document.getElementById('receiver-manual-input').classList.contains('hidden')) {
                toggleInputMode('receiver');
            }
            
            // Fill test data with actual addresses
            document.getElementById('sender-wif-manual').value = 'cUD6caVddi4mue2gLXDasLUJ3zU1GEnKKAfYVbaH4ve9Nxa8NtNu';
            document.getElementById('receiver-address-manual').value = 'tb1qxlp4yvql2j3ujphp7zyytj7z6v99j72q8gxns3';
            
            // Fill amounts
            document.querySelector('input[name="amount"]').value = '1000';
            document.querySelector('input[name="refund-locktime"]').value = '4657650';
            
            showToast('📝 Test data filled - using manual address mode');
            try {
                const senderResponse = await fetch('/api/generate-keypair');
                const senderKey = await senderResponse.json();
                
                const receiverResponse = await fetch('/api/generate-keypair');
                const receiverKey = await receiverResponse.json();
                
                document.getElementById('sender-wif-manual').value = senderKey.wif;
                document.getElementById('receiver-pubkey-manual').value = receiverKey.pubkeyHex;
                
                showToast('📝 Test data filled - ready to test HTLC');
            } catch (error) {
                showError('Failed to generate test data');
            }
        }

        function copyHTLCData() {
            if (window.currentHTLCData) {
                const htlcDataString = JSON.stringify(window.currentHTLCData, null, 2);
                navigator.clipboard.writeText(htlcDataString).then(() => {
                    showToast('📋 HTLC data copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = htlcDataString;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('📋 HTLC data copied to clipboard');
                });
            } else {
                showError('No HTLC data available to copy');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `show ${type}`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            } else {
                console.log('Toast:', message);
            }
        }
    </script>
    
    <div id="toast"></div>
</body>
</html>