<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin HTLC Contracts</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #0d6efd;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background: #5a6268;
        }

        .nav-links a.active {
            background: #0d6efd;
        }

        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
            margin-bottom: 30px;
        }

        .htlc-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .htlc-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .htlc-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #0d6efd;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn {
            background: #0d6efd;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            min-width: auto;
            width: auto;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #198754;
        }

        .btn-success:hover {
            background: #157347;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #bb2d3b;
        }

        .result-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #0d6efd;
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-family: monospace;
            word-break: break-all;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .qr-display {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .success {
            background: #d1e7dd;
            color: #0f5132;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #badbcc;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            color: #0d6efd;
            font-weight: bold;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .network-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .network-status.healthy {
            background: #d1e7dd;
            color: #0f5132;
        }

        .network-status.unhealthy {
            background: #f8d7da;
            color: #721c24;
        }

        .htlc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.pending {
            background: #ffc107;
        }

        .status-indicator.active {
            background: #198754;
        }

        .status-indicator.completed {
            background: #6c757d;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #0d6efd;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 9999;
        }

        #toast.show {
            opacity: 0.95;
        }

        @media (max-width: 768px) {
            .htlc-grid {
                grid-template-columns: 1fr;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .input-with-button input {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Bitcoin HTLC Contracts</h1>
            <p class="subtitle">Hash Time Locked Contracts for secure offline Bitcoin transactions</p>
        </div>

        <div class="nav-links">
            <a href="wallet.html">Wallet</a>
            <a href="index.html" class="active">HTLC Contracts</a>
        </div>

        <div id="network-status" class="network-status">Checking network status...</div>

        <!-- Wallet Overview Section -->
        <div class="htlc-section" id="wallet-overview">
            <h2>üì± Available Wallets</h2>
            <div id="wallet-list" class="htlc-grid">
                <div id="no-wallets-message" style="grid-column: 1 / -1; text-align: center; color: #6c757d;">
                    <p>No wallets found. <a href="wallet.html" style="color: #0d6efd;">Create wallets first ‚Üí</a></p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" id="refresh-wallets-btn">üîÑ Refresh Wallets</button>
            </div>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è REAL BITCOIN TESTNET MODE</strong><br>
            This application creates actual Bitcoin testnet transactions that will be broadcast to the Bitcoin network. 
            Testnet Bitcoin has no monetary value but requires real network interaction.
        </div>

        <div class="htlc-tabs">
            <button class="tab-btn active" data-tab="sender">
                <span class="step-number">1</span>
                Create HTLC
            </button>
            <button class="tab-btn" data-tab="receiver">
                <span class="step-number">2</span>
                Claim Funds
            </button>
            <button class="tab-btn" data-tab="refund">
                <span class="step-number">3</span>
                Refund (Timeout)
            </button>
        </div>

        <!-- Sender Tab -->
        <div id="sender-tab" class="tab-content active">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="sender-status"></span>
                    Create Hash Time Locked Contract
                </h2>
                <form id="sender-form">
                    <div class="htlc-grid">
                        <div>
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Sender Wallet:</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-sender-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="sender-wallet-dropdown">
                                    <select id="sender-wallet-select" name="sender-wallet" required>
                                        <option value="">Select sender wallet...</option>
                                    </select>
                                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                                        <a href="wallet.html" style="color: #0d6efd;">Create wallets in Wallet page ‚Üí</a>
                                    </small>
                                </div>
                                
                                <div id="sender-manual-input" class="hidden">
                                    <input type="text" id="sender-wif-manual" placeholder="Paste sender private key (WIF)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter WIF format private key (starts with 'c' for testnet)</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Receiver:</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-receiver-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="receiver-wallet-dropdown">
                                    <select id="receiver-wallet-select" name="receiver-wallet" required>
                                        <option value="">Select receiver wallet...</option>
                                    </select>
                                    <small style="color: #6c757d;">Receiver's public key will be used for HTLC script</small>
                                </div>
                                
                                <div id="receiver-manual-input" class="hidden">
                                    <input type="text" id="receiver-pubkey-manual" placeholder="Paste receiver public key (hex)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter 66-character hex public key (starts with '02' or '03')</small>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label>Amount (Satoshis):</label>
                                <input type="number" name="amount" value="50000" min="1000" placeholder="50000" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Refund Timelock (Block Height):</label>
                                <input type="number" name="refund-locktime" id="refund-locktime-input" placeholder="4657600" required>
                                <small style="color: #6c757d;">Current block: <span id="current-block">Loading...</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Create HTLC Funding Transaction</button>
                </form>
                
                <div id="sender-results" class="result-section hidden">
                    <h3>üéØ HTLC Created Successfully</h3>
                    <div class="htlc-grid">
                        <div>
                            <div class="result-item">
                                <div class="result-label">HTLC Contract Address</div>
                                <div class="result-value" id="htlc-address"></div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Secret Preimage</div>
                                <div class="result-value" id="preimage-display"></div>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <div class="result-label">Funding Transaction</div>
                                <div class="result-value">
                                    <a href="#" target="_blank" class="tx-link" id="funding-tx-link"></a>
                                </div>
                            </div>
                            <div class="qr-display">
                                <h4>QR Code - HTLC Data</h4>
                                <canvas id="qrcode-canvas"></canvas>
                                <p><small>Scan this to share HTLC details with receiver</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receiver Tab -->
        <div id="receiver-tab" class="tab-content">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="receiver-status"></span>
                    Claim HTLC Funds
                </h2>
                
                <div class="htlc-grid">
                    <div>
                        <h3>Load HTLC Data</h3>
                        <button class="btn btn-secondary" id="scan-qr-btn" style="margin-bottom: 10px;">üì± Scan QR Code</button>
                        <button class="btn btn-secondary" id="paste-data-btn">üìã Paste HTLC Data</button>
                        
                        <div id="htlc-data-display" class="result-section hidden">
                            <h4>HTLC Contract Details</h4>
                            <div id="htlc-info"></div>
                        </div>
                    </div>
                    
                    <div>
                        <form id="receiver-form" class="hidden">
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Receiver Wallet (for claiming):</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-receiver-claim-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="receiver-claim-dropdown">
                                    <select id="receiver-claim-wallet-select" name="receiver-claim-wallet" required>
                                        <option value="">Select wallet to receive funds...</option>
                                    </select>
                                    <small style="color: #6c757d;">Must match the receiver from HTLC creation</small>
                                </div>
                                
                                <div id="receiver-claim-manual-input" class="hidden">
                                    <input type="text" id="receiver-wif-manual" placeholder="Paste receiver private key (WIF)..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter WIF format private key for claiming</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Claim Destination Address:</label>
                                <input type="text" id="claim-address" placeholder="tb1q..." readonly>
                                <small style="color: #6c757d;">Funds will be sent to this address</small>
                            </div>
                            
                            <button type="submit" class="btn btn-success">Claim HTLC Funds</button>
                        </form>
                    </div>
                </div>
                
                <div id="receiver-results" class="result-section hidden">
                    <h3>‚úÖ Funds Claimed Successfully</h3>
                    <div class="result-item">
                        <div class="result-label">Claim Transaction</div>
                        <div class="result-value">
                            <a href="#" target="_blank" class="tx-link" id="claim-tx-link"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refund Tab -->
        <div id="refund-tab" class="tab-content">
            <div class="htlc-section">
                <h2>
                    <span class="status-indicator pending" id="refund-status"></span>
                    Refund HTLC (After Timeout)
                </h2>
                
                <div class="htlc-grid">
                    <div>
                        <h3>HTLC Timeout Status</h3>
                        <div id="timeout-status" class="result-section">
                            <div class="result-item">
                                <div class="result-label">Current Block Height</div>
                                <div class="result-value" id="current-height">Loading...</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Timeout Block Height</div>
                                <div class="result-value" id="timeout-height">N/A</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Status</div>
                                <div class="result-value" id="timeout-status-text">Load HTLC data first</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" id="load-refund-data-btn">üìã Load HTLC Data</button>
                    </div>
                    
                    <div>
                        <form id="refund-form" class="hidden">
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Sender Wallet (for refund):</label>
                                    <button type="button" class="btn btn-secondary" id="toggle-refund-input" style="font-size: 12px; padding: 5px 10px; width: auto;">Manual Input</button>
                                </div>
                                
                                <div id="refund-wallet-dropdown">
                                    <select id="refund-sender-wallet-select" name="refund-sender-wallet" required>
                                        <option value="">Select sender wallet...</option>
                                    </select>
                                    <small style="color: #6c757d;">Must be the original sender wallet from HTLC creation</small>
                                </div>
                                
                                <div id="refund-manual-input" class="hidden">
                                    <input type="text" id="refund-wif-manual" placeholder="Paste sender private key (WIF)..." style="margin-bottom: 10px;">
                                    <input type="text" id="refund-address-manual" placeholder="Paste refund destination address..." style="margin-bottom: 10px;">
                                    <small style="color: #6c757d;">Enter original sender's WIF and destination address</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Refund Destination Address:</label>
                                <input type="text" id="refund-address" placeholder="tb1q..." readonly>
                                <small style="color: #6c757d;">Funds will be sent back to this address</small>
                            </div>
                            
                            <button type="submit" class="btn btn-danger">Create Refund Transaction</button>
                        </form>
                    </div>
                </div>
                
                <div id="refund-results" class="result-section hidden">
                    <h3>üí∞ Refund Transaction Created</h3>
                    <div class="result-item">
                        <div class="result-label">Refund Transaction</div>
                        <div class="result-value">
                            <a href="#" target="_blank" class="tx-link" id="refund-tx-link"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading" class="loading hidden">
            <div>‚è≥ Processing transaction...</div>
        </div>
    </div>

    <script src="https://unpkg.com/qrcode@1.5.4/build/qrcode.min.js"></script>
    <script>
        let currentTab = 'sender';
        let htlcData = null;
        let availableWallets = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Load saved wallets first
            loadSavedWallets();
            // Initialize network status
            await updateNetworkStatus();
            await updateCurrentBlock();
            
            // Tab functionality
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.closest('.tab-btn').getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Wallet selection handlers
            document.getElementById('sender-wallet-select')?.addEventListener('change', handleSenderWalletChange);
            document.getElementById('receiver-wallet-select')?.addEventListener('change', handleReceiverWalletChange);
            document.getElementById('receiver-claim-wallet-select')?.addEventListener('change', handleReceiverClaimWalletChange);
            document.getElementById('refund-sender-wallet-select')?.addEventListener('change', handleRefundSenderWalletChange);
            
            // Toggle handlers for manual input
            document.getElementById('toggle-sender-input')?.addEventListener('click', () => toggleInputMode('sender'));
            document.getElementById('toggle-receiver-input')?.addEventListener('click', () => toggleInputMode('receiver'));
            document.getElementById('toggle-receiver-claim-input')?.addEventListener('click', () => toggleInputMode('receiver-claim'));
            document.getElementById('toggle-refund-input')?.addEventListener('click', () => toggleInputMode('refund'));
            
            // Manual input handlers
            document.getElementById('receiver-wif-manual')?.addEventListener('input', handleReceiverWifInput);
            document.getElementById('refund-address-manual')?.addEventListener('input', handleRefundAddressInput);
            
            // Form handlers
            document.getElementById('sender-form')?.addEventListener('submit', handleSenderForm);
            document.getElementById('receiver-form')?.addEventListener('submit', handleReceiverForm);
            document.getElementById('refund-form')?.addEventListener('submit', handleRefundForm);

            // Action buttons
            document.getElementById('scan-qr-btn')?.addEventListener('click', scanQRCode);
            document.getElementById('paste-data-btn')?.addEventListener('click', pasteHTLCData);
            document.getElementById('load-refund-data-btn')?.addEventListener('click', loadRefundData);
            document.getElementById('refresh-wallets-btn')?.addEventListener('click', refreshWallets);

            // Auto-update current block height
            setInterval(updateCurrentBlock, 30000);
        });

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`)?.classList.add('active');
        }

        async function updateNetworkStatus() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                const statusEl = document.getElementById('network-status');
                
                if (health.status === 'healthy') {
                    statusEl.className = 'network-status healthy';
                    statusEl.textContent = `‚úÖ Network Healthy - Block ${health.network.blockHeight}`;
                } else {
                    statusEl.className = 'network-status unhealthy';
                    statusEl.textContent = '‚ùå Network Issues';
                }
            } catch (error) {
                const statusEl = document.getElementById('network-status');
                statusEl.className = 'network-status unhealthy';
                statusEl.textContent = '‚ùå Connection Error';
            }
        }

        async function updateCurrentBlock() {
            try {
                const response = await fetch('/api/block-height');
                const data = await response.json();
                document.getElementById('current-block').textContent = data.blockHeight;
                document.getElementById('current-height').textContent = data.blockHeight;
                
                // Auto-suggest timeout block (100 blocks in future)
                const timeoutSuggestion = data.blockHeight + 100;
                const timeoutInput = document.getElementById('refund-locktime-input');
                if (timeoutInput && !timeoutInput.value) {
                    timeoutInput.value = timeoutSuggestion;
                }
            } catch (error) {
                console.error('Failed to get current block:', error);
            }
        }

        function loadSavedWallets() {
            const stored = localStorage.getItem('bitcoin-wallets');
            availableWallets = stored ? JSON.parse(stored) : [];
            
            // Populate all wallet dropdowns
            populateWalletDropdowns();
            displayWalletList();
            
            if (availableWallets.length === 0) {
                showToast('‚ÑπÔ∏è No wallets found. Create wallets in the Wallet page first.', 'info');
            }
        }

        function refreshWallets() {
            loadSavedWallets();
            showToast('üîÑ Wallets refreshed');
        }

        function displayWalletList() {
            const walletListDiv = document.getElementById('wallet-list');
            const noWalletsMsg = document.getElementById('no-wallets-message');
            
            if (availableWallets.length === 0) {
                noWalletsMsg.style.display = 'block';
                return;
            }
            
            noWalletsMsg.style.display = 'none';
            
            // Clear existing wallet cards
            walletListDiv.innerHTML = '';
            
            availableWallets.forEach(wallet => {
                const walletCard = document.createElement('div');
                walletCard.className = 'result-item';
                walletCard.innerHTML = `
                    <div class="result-label">${wallet.name} (${wallet.addressType.toUpperCase()})</div>
                    <div class="result-value">
                        <strong>Address:</strong> ${wallet.address}<br>
                        <strong>Balance:</strong> ${wallet.balance} satoshis<br>
                        <strong>Created:</strong> ${new Date(wallet.created).toLocaleDateString()}
                    </div>
                `;
                walletListDiv.appendChild(walletCard);
            });
        }

        function populateWalletDropdowns() {
            const selectors = [
                'sender-wallet-select',
                'receiver-wallet-select', 
                'receiver-claim-wallet-select',
                'refund-sender-wallet-select'
            ];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    // Clear existing options except first
                    select.innerHTML = select.firstElementChild.outerHTML;
                    
                    // Add wallet options
                    availableWallets.forEach(wallet => {
                        const option = document.createElement('option');
                        option.value = wallet.address;
                        option.textContent = `${wallet.name} (${wallet.address.slice(0, 10)}...${wallet.address.slice(-6)}) - ${wallet.balance} sats`;
                        option.dataset.wallet = JSON.stringify(wallet);
                        select.appendChild(option);
                    });
                }
            });
        }

        function handleSenderWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                showToast(`üìù Sender: ${wallet.name} (${wallet.balance} sats)`);
            }
        }

        function handleReceiverWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                showToast(`üìù Receiver: ${wallet.name}`);
            }
        }

        function handleReceiverClaimWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                document.getElementById('claim-address').value = wallet.address;
                showToast(`üìù Claim destination: ${wallet.name}`);
            }
        }

        function handleRefundSenderWalletChange(e) {
            const walletData = e.target.options[e.target.selectedIndex]?.dataset.wallet;
            if (walletData) {
                const wallet = JSON.parse(walletData);
                document.getElementById('refund-address').value = wallet.address;
                showToast(`üìù Refund destination: ${wallet.name}`);
            }
        }

        function toggleInputMode(type) {
            const toggleMaps = {
                'sender': {
                    dropdown: 'sender-wallet-dropdown',
                    manual: 'sender-manual-input',
                    button: 'toggle-sender-input'
                },
                'receiver': {
                    dropdown: 'receiver-wallet-dropdown', 
                    manual: 'receiver-manual-input',
                    button: 'toggle-receiver-input'
                },
                'receiver-claim': {
                    dropdown: 'receiver-claim-dropdown',
                    manual: 'receiver-claim-manual-input', 
                    button: 'toggle-receiver-claim-input'
                },
                'refund': {
                    dropdown: 'refund-wallet-dropdown',
                    manual: 'refund-manual-input',
                    button: 'toggle-refund-input'
                }
            };
            
            const map = toggleMaps[type];
            if (!map) return;
            
            const dropdownDiv = document.getElementById(map.dropdown);
            const manualDiv = document.getElementById(map.manual);
            const toggleBtn = document.getElementById(map.button);
            
            const isManualMode = !manualDiv.classList.contains('hidden');
            
            if (isManualMode) {
                // Switch to dropdown mode
                manualDiv.classList.add('hidden');
                dropdownDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Manual Input';
            } else {
                // Switch to manual mode
                dropdownDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Use Wallets';
            }
        }

        function getSelectedWallet(selectId) {
            const select = document.getElementById(selectId);
            const selectedOption = select.options[select.selectedIndex];
            return selectedOption?.dataset.wallet ? JSON.parse(selectedOption.dataset.wallet) : null;
        }

        function handleReceiverWifInput() {
            const wif = document.getElementById('receiver-wif-manual').value;
            if (wif) {
                generateP2WPKHAddressFromWIF(wif).then(address => {
                    if (address) {
                        document.getElementById('claim-address').value = address;
                    }
                });
            }
        }

        function handleRefundAddressInput() {
            const address = document.getElementById('refund-address-manual').value;
            if (address) {
                document.getElementById('refund-address').value = address;
            }
        }

        async function generateP2WPKHAddressFromWIF(wif) {
            try {
                const response = await fetch('/api/wallet/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'temp', privateKey: wif })
                });
                const wallet = await response.json();
                return wallet.address;
            } catch (error) {
                console.error('Error generating address from WIF:', error);
                return null;
            }
        }

        async function handleSenderForm(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Check if using manual input mode
            const senderManualMode = !document.getElementById('sender-manual-input').classList.contains('hidden');
            const receiverManualMode = !document.getElementById('receiver-manual-input').classList.contains('hidden');
            
            let senderWif, receiverPubkey, senderWallet = null, receiverWallet = null;
            
            if (senderManualMode) {
                senderWif = document.getElementById('sender-wif-manual').value;
                if (!senderWif) {
                    showError('Please enter sender private key');
                    return;
                }
            } else {
                senderWallet = getSelectedWallet('sender-wallet-select');
                if (!senderWallet) {
                    showError('Please select a sender wallet');
                    return;
                }
                senderWif = senderWallet.privateKey;
            }
            
            if (receiverManualMode) {
                receiverPubkey = document.getElementById('receiver-pubkey-manual').value;
                if (!receiverPubkey) {
                    showError('Please enter receiver public key');
                    return;
                }
            } else {
                receiverWallet = getSelectedWallet('receiver-wallet-select');
                if (!receiverWallet) {
                    showError('Please select a receiver wallet');
                    return;
                }
                receiverPubkey = receiverWallet.publicKey;
            }
            
            try {
                showLoading(true);
                document.getElementById('sender-status').className = 'status-indicator active';
                
                const response = await fetch('/api/create-sender-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        senderWif: senderWif,
                        receiverAddress: receiverPubkey,
                        amount: parseInt(formData.get('amount')),
                        refundLocktime: parseInt(formData.get('refund-locktime'))
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    htlcData = {
                        ...result,
                        senderWallet: senderWallet,
                        receiverWallet: receiverWallet,
                        manualMode: { sender: senderManualMode, receiver: receiverManualMode }
                    };
                    displaySenderResults(result);
                    document.getElementById('sender-status').className = 'status-indicator completed';
                    showToast('‚úÖ HTLC created and funded');
                } else {
                    document.getElementById('sender-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to create HTLC');
                }
            } catch (error) {
                document.getElementById('sender-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleReceiverForm(e) {
            e.preventDefault();
            
            if (!htlcData) {
                showError('No HTLC data loaded. Scan QR code or paste data first.');
                return;
            }
            
            // Check if using manual input mode
            const manualMode = !document.getElementById('receiver-claim-manual-input').classList.contains('hidden');
            let receiverWif;
            
            if (manualMode) {
                receiverWif = document.getElementById('receiver-wif-manual').value;
                if (!receiverWif) {
                    showError('Please enter receiver private key');
                    return;
                }
            } else {
                const receiverWallet = getSelectedWallet('receiver-claim-wallet-select');
                if (!receiverWallet) {
                    showError('Please select a receiver wallet');
                    return;
                }
                receiverWif = receiverWallet.privateKey;
            }
            
            try {
                showLoading(true);
                document.getElementById('receiver-status').className = 'status-indicator active';
                
                const response = await fetch('/api/create-receiver-claim-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txoData: htlcData,
                        preimage: htlcData.preimage,
                        receiverWif: receiverWif
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayReceiverResults(result);
                    document.getElementById('receiver-status').className = 'status-indicator completed';
                    showToast('‚úÖ HTLC funds claimed successfully');
                } else {
                    document.getElementById('receiver-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to claim HTLC');
                }
            } catch (error) {
                document.getElementById('receiver-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleRefundForm(e) {
            e.preventDefault();
            
            if (!htlcData) {
                showError('No HTLC data loaded. Load HTLC data first.');
                return;
            }
            
            // Check if using manual input mode
            const manualMode = !document.getElementById('refund-manual-input').classList.contains('hidden');
            let senderWif;
            
            if (manualMode) {
                senderWif = document.getElementById('refund-wif-manual').value;
                if (!senderWif) {
                    showError('Please enter sender private key');
                    return;
                }
            } else {
                const senderWallet = getSelectedWallet('refund-sender-wallet-select');
                if (!senderWallet) {
                    showError('Please select the sender wallet for refund');
                    return;
                }
                senderWif = senderWallet.privateKey;
            }
            
            try {
                showLoading(true);
                document.getElementById('refund-status').className = 'status-indicator active';
                
                const response = await fetch('/api/create-sender-refund-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txoData: htlcData,
                        senderWif: senderWif
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayRefundResults(result);
                    document.getElementById('refund-status').className = 'status-indicator completed';
                    showToast('‚úÖ HTLC refund processed');
                } else {
                    document.getElementById('refund-status').className = 'status-indicator pending';
                    showError(result.error || 'Failed to process refund');
                }
            } catch (error) {
                document.getElementById('refund-status').className = 'status-indicator pending';
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displaySenderResults(result) {
            const resultsDiv = document.getElementById('sender-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('htlc-address').textContent = result.taprootAddress;
            document.getElementById('preimage-display').textContent = result.preimage;
            document.getElementById('funding-tx-link').href = result.explorerUrl || '#';
            document.getElementById('funding-tx-link').textContent = result.txid;
            
            // Add wallet information to results
            if (htlcData.senderWallet && htlcData.receiverWallet) {
                const additionalInfo = document.createElement('div');
                additionalInfo.innerHTML = `
                    <div class="result-item">
                        <div class="result-label">Sender Wallet</div>
                        <div class="result-value">${htlcData.senderWallet.name} (${htlcData.senderWallet.address})</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Receiver Wallet</div>
                        <div class="result-value">${htlcData.receiverWallet.name} (${htlcData.receiverWallet.address})</div>
                    </div>
                `;
                resultsDiv.appendChild(additionalInfo);
            }
            
            // Generate QR code
            const qrData = JSON.stringify({
                txid: result.txid,
                vout: result.vout,
                value: result.value,
                preimage: result.preimage,
                senderPublicKey: result.senderPublicKey,
                refundTimeLock: result.refundTimeLock,
                receiverPublicKey: result.receiverPublicKey,
                htlcAddress: result.taprootAddress,
                senderWallet: htlcData.senderWallet,
                receiverWallet: htlcData.receiverWallet
            });
            
            QRCode.toCanvas(document.getElementById('qrcode-canvas'), qrData, { width: 200 });
        }

        function displayReceiverResults(result) {
            const resultsDiv = document.getElementById('receiver-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('claim-tx-link').href = result.explorerUrl || '#';
            document.getElementById('claim-tx-link').textContent = result.txid;
        }

        function displayRefundResults(result) {
            const resultsDiv = document.getElementById('refund-results');
            resultsDiv.classList.remove('hidden');
            
            document.getElementById('refund-tx-link').href = result.explorerUrl || '#';
            document.getElementById('refund-tx-link').textContent = result.txid;
        }

        function scanQRCode() {
            showToast('üì± QR scanner would open here', 'info');
            // In a real implementation, this would open camera/QR scanner
        }

        function pasteHTLCData() {
            const pastedData = prompt('Paste HTLC transaction data (JSON):');
            if (pastedData) {
                try {
                    htlcData = JSON.parse(pastedData);
                    displayHTLCData();
                    
                    // Auto-select receiver wallet if it exists in saved wallets
                    if (htlcData.receiverWallet) {
                        const receiverSelect = document.getElementById('receiver-claim-wallet-select');
                        const matchingOption = Array.from(receiverSelect.options).find(option => 
                            option.value === htlcData.receiverWallet.address
                        );
                        if (matchingOption) {
                            receiverSelect.value = matchingOption.value;
                            document.getElementById('claim-address').value = htlcData.receiverWallet.address;
                        }
                    }
                    
                    document.getElementById('receiver-form').classList.remove('hidden');
                    showToast('‚úÖ HTLC data loaded');
                } catch (error) {
                    showError('Invalid HTLC data format. Expected JSON.');
                }
            }
        }

        function loadRefundData() {
            const pastedData = prompt('Paste HTLC transaction data (JSON):');
            if (pastedData) {
                try {
                    htlcData = JSON.parse(pastedData);
                    updateTimeoutStatus();
                    
                    // Auto-select sender wallet if it exists in saved wallets
                    if (htlcData.senderWallet) {
                        const senderSelect = document.getElementById('refund-sender-wallet-select');
                        const matchingOption = Array.from(senderSelect.options).find(option => 
                            option.value === htlcData.senderWallet.address
                        );
                        if (matchingOption) {
                            senderSelect.value = matchingOption.value;
                            document.getElementById('refund-address').value = htlcData.senderWallet.address;
                        }
                    }
                    
                    document.getElementById('refund-form').classList.remove('hidden');
                    showToast('‚úÖ HTLC data loaded for refund');
                } catch (error) {
                    showError('Invalid HTLC data format. Expected JSON.');
                }
            }
        }

        function displayHTLCData() {
            if (!htlcData) return;
            
            const display = document.getElementById('htlc-data-display');
            display.classList.remove('hidden');
            
            document.getElementById('htlc-info').innerHTML = `
                <div class="result-item">
                    <div class="result-label">HTLC Address</div>
                    <div class="result-value">${htlcData.htlcAddress || htlcData.taprootAddress}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Amount</div>
                    <div class="result-value">${htlcData.value} satoshis</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Timeout Block</div>
                    <div class="result-value">${htlcData.refundTimeLock}</div>
                </div>
            `;
        }

        function updateTimeoutStatus() {
            if (!htlcData) return;
            
            document.getElementById('timeout-height').textContent = htlcData.refundTimeLock;
            
            const currentBlock = parseInt(document.getElementById('current-height').textContent);
            const timeoutBlock = htlcData.refundTimeLock;
            
            const statusText = document.getElementById('timeout-status-text');
            if (currentBlock >= timeoutBlock) {
                statusText.textContent = '‚úÖ Timeout reached - Refund available';
                statusText.style.color = '#198754';
            } else {
                const blocksRemaining = timeoutBlock - currentBlock;
                statusText.textContent = `‚è∞ ${blocksRemaining} blocks until timeout`;
                statusText.style.color = '#856404';
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
    
    <div id="toast"></div>
</body>
</html>